<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SQLx (acesso BD) - Treinamento Rust</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="treinamento.html"><strong aria-hidden="true">1.</strong> Treinamento</a></li><li class="chapter-item expanded "><a href="instalação.html"><strong aria-hidden="true">2.</strong> Instalação</a></li><li class="chapter-item expanded "><a href="introdução.html"><strong aria-hidden="true">3.</strong> Introdução</a></li><li class="chapter-item expanded "><a href="hello_world.html"><strong aria-hidden="true">4.</strong> Hello word</a></li><li class="chapter-item expanded "><a href="tipos_de_variáveis.html"><strong aria-hidden="true">5.</strong> Tipos de variáveis</a></li><li class="chapter-item expanded "><a href="trabalhando_com_strings.html"><strong aria-hidden="true">6.</strong> Trabalhando com Strings</a></li><li class="chapter-item expanded "><a href="funções,_testes_unitários_e_doc.html"><strong aria-hidden="true">7.</strong> Funções, testes unitários e doc</a></li><li class="chapter-item expanded "><a href="controle_de_fluxo.html"><strong aria-hidden="true">8.</strong> Controle de fluxo (if, while, for)</a></li><li class="chapter-item expanded "><a href="declarar_objetos.html"><strong aria-hidden="true">9.</strong> Declarar objetos</a></li><li class="chapter-item expanded "><a href="enumerados.html"><strong aria-hidden="true">10.</strong> Enumerados</a></li><li class="chapter-item expanded "><a href="ownership_e_borrowing.html"><strong aria-hidden="true">11.</strong> Ownership e borrowing</a></li><li class="chapter-item expanded "><a href="collections_e_iterators.html"><strong aria-hidden="true">12.</strong> Collections e Iterators</a></li><li class="chapter-item expanded "><a href="option.html"><strong aria-hidden="true">13.</strong> Option (opcional)</a></li><li class="chapter-item expanded "><a href="tratamento_de_erro.html"><strong aria-hidden="true">14.</strong> Tratamento de erro</a></li><li class="chapter-item expanded "><a href="trabalhando_com_result.html"><strong aria-hidden="true">15.</strong> Trabalhando com Result</a></li><li class="chapter-item expanded "><a href="exercícios.html"><strong aria-hidden="true">16.</strong> Exercícios</a></li><li class="chapter-item expanded "><a href="CLI_structopt.html"><strong aria-hidden="true">17.</strong> CLI structopt</a></li><li class="chapter-item expanded "><a href="manipular_json.html"><strong aria-hidden="true">18.</strong> Manipulação JSON</a></li><li class="chapter-item expanded "><a href="arquivos.html"><strong aria-hidden="true">19.</strong> Leitura e gravação de arquivos</a></li><li class="chapter-item expanded "><a href="date_time.html"><strong aria-hidden="true">20.</strong> Date time</a></li><li class="chapter-item expanded "><a href="smart_pointers.html"><strong aria-hidden="true">21.</strong> Smart pointers</a></li><li class="chapter-item expanded "><a href="threads.html"><strong aria-hidden="true">22.</strong> Threads</a></li><li class="chapter-item expanded "><a href="sintaxe_async.html"><strong aria-hidden="true">23.</strong> Sintaxe async</a></li><li class="chapter-item expanded "><a href="sqlx.html" class="active"><strong aria-hidden="true">24.</strong> SQLx (acesso BD)</a></li><li class="chapter-item expanded "><a href="traits.html"><strong aria-hidden="true">25.</strong> Traits (interfaces)</a></li><li class="chapter-item expanded "><a href="closures.html"><strong aria-hidden="true">26.</strong> Closures</a></li><li class="chapter-item expanded "><a href="estrutura_de_diretórios.html"><strong aria-hidden="true">27.</strong> Estrutura de diretórios</a></li><li class="chapter-item expanded "><a href="clonar_structs.html"><strong aria-hidden="true">28.</strong> Clonar structs</a></li><li class="chapter-item expanded "><a href="api_design.html"><strong aria-hidden="true">29.</strong> API design</a></li><li class="chapter-item expanded "><a href="debug.html"><strong aria-hidden="true">30.</strong> Debug</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Treinamento Rust</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sqlx-acesso-bd"><a class="header" href="#sqlx-acesso-bd">SQLx (acesso BD)</a></h1>
<h2 id="introdução"><a class="header" href="#introdução">Introdução</a></h2>
<p>Existem várias bibliotecas para acessar banco de dados em Rust.
Entretanto não existe uma interface padrão para isso, tal como ODBC, OleDB ou JDBC.
Então ocorre que em geral as bibliotecas possuem suas próprias API que não compatíveis entre si.</p>
<p>No nosso treinamento iremos utilizar a <a href="https://github.com/launchbadge/sqlx">biblioteca <em>SQLx</em></a> que permite acessar PostGres, MySQL, MSSQL e SQLite.</p>
<p>Essa biblioteca não é um <em>ORM</em>, ou seja, ele não faz um mapeamento de objeto para modelo relacional do banco de dados.
Geralmente os <em>ORMs</em> disponibilizam uma API ou uma nova DSL para abstrair o SQL.
O principal motivo é forçar uma tipagem, de forma a validar a <em>query</em> em tempo de compilação, pois geralmente a <em>SQL</em> é definida em texto (<em>string</em>).
O problema disso é que essa API deve estudada, sem falar que muitas vezes fica mais verboso.</p>
<p>A grande vantagem do <em>SQLx</em> é que usa a <em>SQL</em> nativa do banco de dados e a <strong>valida em tempo de compilação</strong>.
Na prática a biblioteca valida a <em>string</em> diretamente conectando no banco de dados, graças a características que as macros são rotinas que podem ser executadas
em tempo de compilação. E a consulta também <strong>retorna objetos com os nomes e tipos
apropriados respeitando a SQL</strong>, ou seja, não tem como acessar um campo pelo nome ou tipo errado.</p>
<p>Isso tudo o torna extremamente poderoso, resultando em <strong>produtividade e qualidade</strong> (menos bugs).</p>
<h2 id="dependência"><a class="header" href="#dependência">Dependência</a></h2>
<p>Para usar a biblioteca devemos inserir a dependência no <code>Cargo.toml</code>:</p>
<pre><code class="language-ini">sqlx = {version = &quot;0.5.7&quot;, features = [&quot;sqlite&quot;, &quot;runtime-async-std-native-tls&quot;]}
</code></pre>
<p>No treinamento iremos praticar com SQLite, observe que acima inserimos uma <em>feature</em> <code>sqlite</code>.</p>
<p>A outra <em>feature</em> é a <code>runtime-async-std-native-tls</code>, que indica que iremos usar a runtime assíncrona <em>Async-std</em>.</p>
<h2 id="instalação"><a class="header" href="#instalação">Instalação</a></h2>
<p>O SQLx possui uma ferramenta para executar comandos pela linha de comando. Para instalar devemos executar:</p>
<pre><code class="language-terminal">cargo install sqlx-cli --no-default-features --features sqlite
</code></pre>
<p>Depois disso podemos executar os campos pelo programa <code>sqlx</code>.</p>
<h2 id="projeto-de-treinamento-todo"><a class="header" href="#projeto-de-treinamento-todo">Projeto de treinamento <em>TODO</em></a></h2>
<p>Para exercitarmos vamos clonar um projeto de teste já existente, <a href="http://gitlab.rechinfo.local/gitlab/rech/rust/treinamento/sqlx-todo">sqlx-todo</a>.
Esse programa serve como um cadastro simples de <em>To do list</em>.</p>
<p>Vamos clonar o projeto, entre no diretório <code>c:\fontes\rust</code> e digite :</p>
<pre><code class="language-terminal">git clone http://gitlab.rechinfo.local/gitlab/rech/rust/treinamento/sqlx-todo.git
</code></pre>
<p>Será criado o diretório <code>sqlx-todo</code>. Abra esse diretório no <em>VSCode</em>.</p>
<p>Uma novidade é a função <code>main</code>, que nosso projeto já uma função assíncrona:</p>
<pre><pre class="playground"><code class="language-rust">#[paw::main]
#[async_std::main]
async fn main(args: Args) -&gt; Result&lt;()&gt; {
    // ...
}
</code></pre></pre>
<h2 id="arquivo-env"><a class="header" href="#arquivo-env">Arquivo <code>.env</code></a></h2>
<p>Uma das principais formas para parametrizar os dados de conexão é através de variável de ambiente.
Entretanto as vezes pode ser útil também ler através de um arquivo.
Para facilitar isso existe uma técnica utilizada por diversas ferramentas (inclusive o <em>SQLx</em>), que tenta carregar variáveis de ambiente através de um arquivo <code>.env</code> contido no diretório corrente ou anterior.</p>
<p>Cada linguagem possui suas bibliotecas para ler esse arquivo <code>.env</code> e definir as variáveis de ambiente.</p>
<p>No caso do Rust usaremos a biblioteca <code>dotenv</code>.</p>
<h2 id="criar-o-banco-de-dados"><a class="header" href="#criar-o-banco-de-dados">Criar o banco de dados</a></h2>
<p>Criar banco de dados a partir da definição do arquivo <code>.env</code> devemos executar:</p>
<pre><code class="language-terminal">sqlx db create
</code></pre>
<p>A execução desse comando cria o arquivo <code>todos.db</code> na raiz do projeto.</p>
<h2 id="migration"><a class="header" href="#migration"><em>Migration</em></a></h2>
<p>O termo <em>migration</em> (migração) geralmente é utilizado por bibliotecas de acesso a banco de dados, como o procedimento
para manter o banco de dados da aplicação com a estrutura esperada, registrando e executando as operações necessários.</p>
<p>Cada mudança no banco deve ser registrado num arquivo de migração, que contém a SQL para fazer a alteração (<code>CREATE TABLE</code>, <code>ALTER TABLE</code>, <code>DROP TABLE</code>, etc).</p>
<p>O <em>SQLx</em> contém um controle para saber quais arquivos de migração devem ser executados, executando as adaptações necessárias.
Os arquivos de migração ficam localizados no diretório <code>migrations</code> na raiz do projeto.</p>
<p>Essas migrações podem ser executadas tanto no ambiente de produção quanto de desenvolvimento. Para fazer as migrações devemos executar o comando:</p>
<pre><code>sqlx migrate run
</code></pre>
<h2 id="execução-do-programa-de-teste-todo"><a class="header" href="#execução-do-programa-de-teste-todo">Execução do programa de teste <em>TODO</em></a></h2>
<p>Listar os <em>TODOs</em>:</p>
<pre><code class="language-terminal">cargo run --
</code></pre>
<p>Inserir novo <em>TODO</em>:</p>
<pre><code class="language-terminal">cargo run -- add [descrição]
</code></pre>
<p>Marcar <em>TODO</em> como realizado:</p>
<pre><code class="language-terminal">cargo run -- done [id]
</code></pre>
<h2 id="sqlx"><a class="header" href="#sqlx"><em>SQLx</em></a></h2>
<p>O funcionamento do <em>SQLx</em> é bem simples. A primeira coisa que devemos
saber é que uma biblioteca assíncrona, ou seja, as funções devem ser executada
em contexto <em>async</em>.</p>
<p>Para conectar no banco existe o método <code>SqlitePool::connect</code>:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let pool = SqlitePool::connect(&amp;env::var(&quot;DATABASE_URL&quot;)?).await?;
<span class="boring">}
</span></code></pre></pre>
<p>Esse objeto pode ser clonado várias vezes sem nenhum problema, ele gerencia um <em>pool</em> de conexão de forma transparente, ou seja, não será feita um conexão para instância
clonada a não ser que seja realmente necessário.</p>
<p>Para executar comando <em>SQL</em> (<em>SELECT, INSERT, UPDATE</em>, etc) devemos usar a macro <code>query!</code>, tal como:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let recs = query!(r#&quot;SELECT id, description, done FROM todos ORDER BY id&quot;#)
    .fetch_all(pool)
    .await?;
<span class="boring">}
</span></code></pre></pre>
<p>Observe que o <code>pool</code> é passado para o método <code>fetch_all</code>. O retorno <code>recs</code> será
um objeto criado dinamicamente em tempo de compilação, de acordo com o tipo dos campos selecionados.</p>
<h2 id="exercícios"><a class="header" href="#exercícios">Exercícios</a></h2>
<ul>
<li>No programa de exemplo ele tem uma funcionalidade para listar os <em>TODOs</em>. Crie uma parametrização na <em>command line</em> para permitir escolher a ordem (id, descrição, concluído, etc).</li>
<li>Nessa mesma funcionalidade de listar, permita parametrizar se deve exibir os já concluídos ou não.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="sintaxe_async.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="traits.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="sintaxe_async.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="traits.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
